<html>
  <head>
    <meta charset="utf-8" />
    <title>Insane Tetris</title>
    <style>
      * {
        padding: 0;
        margin: 0;
      }

      canvas {
        background: rgb(100, 100, 100);
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>

  <body>
    <div style="height: 100vh; background-color: antiquewhite">
      <canvas
        id="myCanvas"
        width="500"
        height="600"
        style="background-color: transparent"
      ></canvas>

      <div
        style="text-align: center; font-family: Arial, Helvetica, sans-serif"
      >
        <h3 style="margin-bottom: 10px">How to play?</h3>
        <ul style="list-style-type: none">
          <li><b>Left / right</b>: move left / right</li>
          <li><b>P</b>: pause game</li>
          <li><b>Space</b>: fast mode</li>
          <li><b>Enter</b>: instantly lay block</li>
        </ul>
      </div>
    </div>

    <script>
      const canvas = document.getElementById("myCanvas")
      const ctx = canvas.getContext("2d")

      const gridWidth = 200
      const gridHeight = 500
      const numberOfColumns = 8
      const numberOfRows = 20
      const canvasToGridWidth = (canvas.width - gridWidth) / 2
      const canvasToGridHeight = (canvas.height - gridHeight) / 2
      const brickWidth = gridWidth / numberOfColumns
      const brickHeight = gridHeight / numberOfRows
      const isOccupied = Array.from({ length: numberOfColumns }, (_) =>
        Array.from({ length: numberOfRows }, (_) => false)
      )

      let movingPiece = undefined
      let tickCounter = 0
      let score = 0

      let spaceKeyPressed = false
      let layingMode = false
      let isPaused = false
      let gameOver = false

      function keyDownHandler(event) {
        if (event.code === "ArrowLeft") moveLeft()
        if (event.code === "ArrowRight") moveRight()
        if (event.code === "Space") spaceKeyPressed = true
        if (event.code === "Enter") layingMode = true
        if (event.code === "KeyP") {
          isPaused = !isPaused
          layingMode = false
          spaceKeyPressed = false
        }
      }

      function keyUpHandler(event) {
        if (event.code === "Space") spaceKeyPressed = false
      }

      function drawBrick(column, row, color) {
        const x = column * brickWidth + canvasToGridWidth
        const y = row * brickHeight + canvasToGridHeight

        ctx.beginPath()
        ctx.rect(x, y, brickWidth, brickHeight)
        if (color) {
          ctx.fillStyle = color
          ctx.fill()
        }
        ctx.stroke()
        ctx.closePath()
      }

      function drawGrid() {
        for (let column = 0; column < numberOfColumns; column++) {
          for (let row = 0; row < numberOfRows; row++) {
            drawBrick(
              column,
              row,
              isOccupied[column][row] ? "rgb(255, 100, 50)" : undefined
            )
          }
        }
      }

      function drawScore() {
        ctx.font = "25px sans-serif"
        ctx.fillStyle = "rgb(0, 0, 0)"
        ctx.textAlign = "center"
        ctx.textBaseline = "middle"
        ctx.fillText(
          `Score: ${score}`,
          canvas.width / 2,
          canvasToGridHeight / 2
        )
      }

      function drawBanner(...lines) {
        const fontSize = 45
        const interline = fontSize

        ctx.beginPath()
        ctx.rect(canvasToGridWidth, canvasToGridHeight, gridWidth, gridHeight)
        ctx.fillStyle = "rgba(255, 100, 100, 0.75)"
        ctx.fill()
        ctx.closePath()

        ctx.font = `bold ${fontSize}px sans-serif`
        ctx.fillStyle = "rgb(70, 70, 70)"
        ctx.textAlign = "center"
        ctx.textBaseline = "middle"

        let y =
          canvasToGridHeight +
          gridHeight / 2 -
          ((lines.length - 1) / 2) * interline

        for (const line of lines) {
          ctx.fillText(line, canvas.width / 2, y, gridWidth - 15)
          y += interline
        }
      }

      function moveRight() {
        if (
          movingPiece.column < numberOfColumns - 1 &&
          !isOccupied[movingPiece.column + 1][movingPiece.row]
        ) {
          movingPiece.column++
        }
      }

      function moveLeft() {
        if (
          movingPiece.column > 0 &&
          !isOccupied[movingPiece.column - 1][movingPiece.row]
        ) {
          movingPiece.column--
        }
      }

      function layPiece() {
        for (let row = movingPiece.row; row < numberOfRows; row++) {
          if (!isOccupied[movingPiece.column][row]) {
            movingPiece.row = row
          } else return
        }
      }

      function isRowFull(row) {
        for (let column = 0; column < numberOfColumns; column++) {
          if (!isOccupied[column][row]) return false
        }
        return true
      }

      function removeFullRow(rowToRemove) {
        for (let column = 0; column < numberOfColumns; column++) {
          for (let row = rowToRemove; row > 0; row--) {
            isOccupied[column][row] = isOccupied[column][row - 1]
          }
        }

        score += 90
      }

      function isBrickOnFirstRow() {
        for (let column = 0; column < numberOfColumns; column++) {
          if (isOccupied[column][0]) return true
        }
        return false
      }

      function movePieceDown() {
        tickCounter++
        if (tickCounter < 4 && !spaceKeyPressed) return

        if (layingMode) {
          layPiece()
          layingMode = false
        }

        if (
          movingPiece.row < numberOfRows - 1 &&
          !isOccupied[movingPiece.column][movingPiece.row + 1]
        ) {
          movingPiece.row++
        } else {
          isOccupied[movingPiece.column][movingPiece.row] = true
          movingPiece = undefined
          score += 10
        }

        tickCounter = 0
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height)
        drawGrid()
        drawScore()

        if (movingPiece) {
          drawBrick(
            movingPiece.column,
            movingPiece.row,
            false ? "rgb(255, 25, 225)" : "rgb(123, 25, 250)"
          )
        }

        if (gameOver) {
          drawBanner("Game", "Over")
        } else if (isPaused) {
          drawBanner("Paused")
        }
      }

      function tick() {
        if (isBrickOnFirstRow()) gameOver = true

        draw()

        if (gameOver || isPaused) return

        if (movingPiece) {
          movePieceDown()
        } else {
          movingPiece = { row: 0, column: Math.floor(numberOfColumns / 2 - 1) }
        }

        for (row = 0; row < numberOfRows; row++) {
          if (isRowFull(row)) removeFullRow(row)
        }
      }

      document.addEventListener("keydown", keyDownHandler, false)
      document.addEventListener("keyup", keyUpHandler, false)

      setInterval(tick, 50)
    </script>
  </body>
</html>
