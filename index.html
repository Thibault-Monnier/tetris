<html>
  <head>
    <meta charset="utf-8" />
    <title>Mini Mario</title>
    <style>
      * {
        padding: 0;
        margin: 0;
      }

      canvas {
        background: rgb(100, 100, 100);
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>

  <body>
    <div style="height: 100vh; background-color: antiquewhite">
      <canvas
        id="myCanvas"
        width="500"
        height="600"
        style="background-color: transparent"
      ></canvas>

      <div
        style="text-align: center; font-family: Arial, Helvetica, sans-serif"
      >
        <h3 style="margin-bottom: 10px">How to play?</h3>
        <ul style="list-style-type: none">
          <li><b>Left / right</b>: move left / right</li>
          <li><b>P</b>: pause game</li>
          <li><b>Space</b>: fast mode</li>
          <li><b>Enter</b>: instantly lay block</li>
        </ul>
      </div>
    </div>

    <script>
      const canvas = document.getElementById("myCanvas")
      const ctx = canvas.getContext("2d")

      const gridWidth = 200
      const gridHeight = 500
      const numberOfColumns = 8
      const numberOfRows = 20
      const isOccupied = Array.from({ length: numberOfColumns }, (_) =>
        Array.from({ length: numberOfRows }, (_) => false)
      )

      let movingBrick = undefined
      let tickCounter = 0
      let score = 0

      let spaceKeyPressed = false
      let layingMode = false
      let isPaused = false
      let gameOver = false

      function keyDownHandler(event) {
        if (event.code === "ArrowLeft") moveLeft()
        if (event.code === "ArrowRight") moveRight()
        if (event.code === "Space") spaceKeyPressed = true
        if (event.code === "Enter") layingMode = true
        if (event.code === "KeyP") {
          isPaused = !isPaused
          layingMode = false
          spaceKeyPressed = false
        }
      }

      function keyUpHandler(event) {
        if (event.code === "Space") spaceKeyPressed = false
      }

      function drawBrick(column, row, color) {
        const canvasToGridWidth = (canvas.width - gridWidth) / 2
        const canvasToGridHeight = (canvas.height - gridHeight) / 2
        const rectWidth = gridWidth / numberOfColumns
        const rectHeight = gridHeight / numberOfRows
        const x = column * rectWidth + canvasToGridWidth
        const y = row * rectHeight + canvasToGridHeight

        ctx.beginPath()
        ctx.rect(x, y, rectWidth, rectHeight)
        if (color) {
          ctx.fillStyle = color
          ctx.fill()
        }
        ctx.stroke()
        ctx.closePath()
      }

      function drawGrid() {
        for (let column = 0; column < numberOfColumns; column++) {
          for (let row = 0; row < numberOfRows; row++) {
            drawBrick(
              column,
              row,
              isOccupied[column][row] ? "rgb(255, 100, 50)" : undefined
            )
          }
        }
      }

      function drawScore() {
        ctx.font = "25px sans-serif"
        ctx.fillStyle = "rgb(0, 0, 0)"
        ctx.textAlign = "center"
        ctx.fillText(`Score: ${score}`, canvas.width / 2, 35)
      }

      function drawBanner(text) {
        ctx.beginPath()
        ctx.rect(canvas.width / 5, canvas.height / 3, canvas.width * 3 / 5, canvas.height / 3 )
        ctx.fillStyle = "rgba(255, 100, 100, 0.75)"
        ctx.fill()
        ctx.closePath()

        ctx.font = "50px sans-serif"
        ctx.fillStyle = "rgb(0, 0, 0)"
        ctx.textAlign = "center"
        ctx.fillText(text, canvas.width / 2, canvas.height / 2)
      }

      function moveRight() {
        if (
          movingBrick.column < numberOfColumns - 1 &&
          !isOccupied[movingBrick.column + 1][movingBrick.row]
        ) {
          movingBrick.column++
        }
      }

      function moveLeft() {
        if (
          movingBrick.column > 0 &&
          !isOccupied[movingBrick.column - 1][movingBrick.row]
        ) {
          movingBrick.column--
        }
      }

      function layBrick() {
        for (let row = movingBrick.row; row < numberOfRows; row++) {
          if (!isOccupied[movingBrick.column][row]) {
            movingBrick.row = row
          } else return
        }
      }

      function isRowFull(row) {
        for (let column = 0; column < numberOfColumns; column++) {
          if (!isOccupied[column][row]) return false
        }
        return true
      }

      function removeFullRow(rowToRemove) {
        for (let column = 0; column < numberOfColumns; column++) {
          for (let row = rowToRemove; row > 0; row--) {
            isOccupied[column][row] = isOccupied[column][row - 1]
          }
        }

        score += 90
      }

      function isBrickOnFirstRow() {
        for (let column = 0; column < numberOfColumns; column++) {
          if (isOccupied[column][0]) return true
        }
        return false
      }

      function moveBrickDown() {
        tickCounter++
        if (tickCounter < 4 && !spaceKeyPressed) return

        if (layingMode) {
          layBrick()
          layingMode = false
        }

        if (
          movingBrick.row < numberOfRows - 1 &&
          !isOccupied[movingBrick.column][movingBrick.row + 1]
        ) {
          movingBrick.row++
        } else {
          isOccupied[movingBrick.column][movingBrick.row] = true
          movingBrick = undefined
          score += 10
        }

        tickCounter = 0
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height)
        drawGrid()
        drawScore()

        if (gameOver) drawBanner("Game Over")

        if (isPaused) drawBanner("Paused")

        if (movingBrick) {
          drawBrick(movingBrick.column, movingBrick.row, "rgb(123, 25, 250)")
        }
      }

      function tick() {
        if (isBrickOnFirstRow()) gameOver = true

        draw()

        if (gameOver || isPaused) return

        if (movingBrick) {
          moveBrickDown()
        } else {
          movingBrick = { row: 0, column: Math.floor(numberOfColumns / 2 - 1) }
        }

        for (row = 0; row < numberOfRows; row++) {
          if (isRowFull(row)) removeFullRow(row)
        }
      }

      document.addEventListener("keydown", keyDownHandler, false)
      document.addEventListener("keyup", keyUpHandler, false)

      setInterval(tick, 50)
    </script>
  </body>
</html>
