<html>
  <head>
    <meta charset="utf-8" />
    <title>Mini Mario</title>
    <style>
      * {
        padding: 0;
        margin: 0;
      }

      canvas {
        background: rgb(100, 100, 100);
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>

  <body>
    <canvas id="myCanvas" width="800" height="800"></canvas>

    <script>
      const canvas = document.getElementById("myCanvas")
      const ctx = canvas.getContext("2d")

      const gridWidth = 200
      const gridHeight = 500
      const numberOfColumns = 8
      const numberOfRows = 20
      const isOccupied = Array.from({ length: numberOfColumns }, (_) =>
        Array.from({ length: numberOfRows }, (_) => false)
      )

      let movingBrick = undefined
      let tickCounter = 0

      let spaceKeyPressed = false
      let layingMode = false
      let isPaused = false

      function keyDownHandler(event) {
        if (event.code === "ArrowLeft") moveLeft()
        if (event.code === "ArrowRight") moveRight()
        if (event.code === "Space") spaceKeyPressed = true
        if (event.code === "Enter") layingMode = true
        if (event.code === "KeyP") isPaused = !isPaused
      }

      function keyUpHandler(event) {
        if (event.code === "Space") spaceKeyPressed = false
        if (event.code === "Enter") layingMode = false
      }

      function drawBrick(column, row, color) {
        const canvasToGridWidth = (canvas.width - gridWidth) / 2
        const canvasToGridHeight = (canvas.height - gridHeight) / 2
        const rectWidth = gridWidth / numberOfColumns
        const rectHeight = gridHeight / numberOfRows
        const x = column * rectWidth + canvasToGridWidth
        const y = row * rectHeight + canvasToGridHeight

        ctx.beginPath()
        ctx.rect(x, y, rectWidth, rectHeight)
        if (color) {
          ctx.fillStyle = color
          ctx.fill()
        }
        ctx.stroke()
        ctx.closePath()
      }

      function drawGrid() {
        for (let column = 0; column < numberOfColumns; column++) {
          for (let row = 0; row < numberOfRows; row++) {
            drawBrick(
              column,
              row,
              isOccupied[column][row] ? "rgb(255, 100, 50)" : undefined
            )
          }
        }
      }

      function moveRight() {
        if (
          movingBrick.column < numberOfColumns - 1 &&
          !isOccupied[movingBrick.column + 1][movingBrick.row]
        ) {
          movingBrick.column++
        }
      }

      function moveLeft() {
        if (
          movingBrick.column > 0 &&
          !isOccupied[movingBrick.column - 1][movingBrick.row]
        ) {
          movingBrick.column--
        }
      }

      function layBrick() {
        for (let row = movingBrick.row; row < numberOfRows; row++) {
          if (!isOccupied[movingBrick.column][row]) {
            movingBrick.row = row
          } else return
        }
      }

      function moveBrick() {
        tickCounter++
        if (tickCounter < 4 && !spaceKeyPressed) return

        if (layingMode) {
          layBrick()
          layingMode = false
        }

        if (
          movingBrick.row < numberOfRows - 1 &&
          !isOccupied[movingBrick.column][movingBrick.row + 1]
        ) {
          movingBrick.row++
        } else {
          isOccupied[movingBrick.column][movingBrick.row] = true
          movingBrick = undefined
        }

        tickCounter = 0
      }

      function tick() {
        if (isPaused) return

        ctx.clearRect(0, 0, canvas.width, canvas.height)
        drawGrid()

        if (movingBrick) {
          drawBrick(movingBrick.column, movingBrick.row, "rgb(123, 25, 250)")
          moveBrick()
        } else {
          movingBrick = { row: 0, column: Math.floor(numberOfColumns / 2 - 1) }
        }
      }

      document.addEventListener("keydown", keyDownHandler, false)
      document.addEventListener("keyup", keyUpHandler, false)

      setInterval(tick, 50)
    </script>
  </body>
</html>
